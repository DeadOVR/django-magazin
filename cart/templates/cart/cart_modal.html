<div id="cart-modal" class="fixed right-0 top-0 h-screen w-full max-w-md bg-white shadow-2xl z-50 transition-transform duration-300">
    <div class="h-full flex flex-col">
        <!-- Cart Header -->
        <div class="flex justify-between items-center p-6 border-b">
            <h1 class="text-2xl font-bold">КОРЗИНА (<span id="cart-count">{{ cart.total_items }}</span>)</h1>
            <button onclick="closeCart()" class="text-2xl hover:text-gray-600">×</button>
        </div>

        <!-- Cart Items -->
        <div class="flex-1 overflow-y-auto p-6">
            <div id="cart-items" class="space-y-8">
                {% for item in cart_items %}
                    {% include 'cart/cart_item.html' %}
                {% empty %}
                    <div class="text-center py-20 text-gray-500">
                        <p class="text-lg mb-4">Ваша корзина пуста</p>
                        <button onclick="closeCart()" class="text-sm underline">Продолжить покупки</button>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Cart Footer -->
        <div id="cart-summary" class="border-t p-6">
            {% if cart_items %}
                {% include 'cart/cart_summary.html' %}
            {% else %}
                <div class="text-center text-gray-500">
                    <p>Your cart is empty</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Cart Overlay -->
<div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-all duration-300"></div>

<style>
    #cart-modal {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }

    #cart-modal.open {
        transform: translateX(0);
    }

    #cart-modal.closed {
        transform: translateX(100%);
    }

    #cart-modal.closing-right {
        transform: translateX(100%);
    }

    #cart-overlay {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }

    #cart-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    #cart-overlay.closed {
        opacity: 0;
        visibility: hidden;
    }

    /* Адаптивные стили */
    @media (max-width: 640px) {
        #cart-modal {
            width: 100%;
            max-width: 100%;
        }
    }
</style>

<script>
    console.log('Cart modal template loaded');

    // Функция для открытия корзины
    function openCartModal() {
        console.log('openCartModal function called');
        const modal = document.getElementById('cart-modal');
        const cartOverlay = document.getElementById('cart-overlay');

        console.log('Modal element:', modal);
        console.log('Overlay element:', cartOverlay);

        if (modal && cartOverlay) {
            modal.classList.remove('closed', 'closing-right');
            modal.classList.add('open');
            cartOverlay.classList.remove('closed');
            cartOverlay.classList.add('open');
            console.log('Cart modal opened successfully');
        } else {
            console.error('Modal or overlay not found');
        }
    }

    // Функция для закрытия корзины
    function closeCart(direction = 'left') {
        const modal = document.getElementById('cart-modal');
        const cartOverlay = document.getElementById('cart-overlay');

        if (modal && cartOverlay) {
            modal.classList.remove('open');
            cartOverlay.classList.remove('open');

            if (direction === 'right') {
                modal.classList.add('closing-right');
            } else {
                modal.classList.add('closed');
            }
            cartOverlay.classList.add('closed');

            setTimeout(() => {
                const container = document.getElementById('cart-container');
                if (container) {
                    container.innerHTML = '';
                }
            }, 300);
        }
    }

    // Функция для перехода к оплате
    function proceedToCheckout() {
        closeCart('right');

        setTimeout(() => {
            htmx.ajax('GET', '{% url "orders:checkout" %}', {
                target: '#main-content',
                swap: 'innerHTML'
            });
        }, 200);
    }

    // Сделаем функцию глобальной
    window.openCartModal = openCartModal;

    // Автоматическое открытие при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Cart modal DOM loaded');
        setTimeout(openCartModal, 100);
    });

    // HTMX обработчик
    document.addEventListener('htmx:afterSwap', function(evt) {
        console.log('HTMX afterSwap in cart modal', evt.detail.elt.id);
        if (evt.detail.elt.id === 'cart-modal') {
            console.log('Cart modal swapped, opening...');
            setTimeout(openCartModal, 100);
        }
    });

    // Также попробуем открыть сразу после загрузки скрипта
    setTimeout(openCartModal, 200);
</script>